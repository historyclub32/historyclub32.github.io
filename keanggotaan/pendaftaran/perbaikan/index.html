<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Perbaikan Data - HC 32</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/remixicon/3.5.0/remixicon.css" rel="stylesheet">

  <script src="/config.js"></script>
  <script src="/components.js"></script>
  
  <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.1.7/dist/signature_pad.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>

  <style>
    /* Styling khusus untuk menyelaraskan dengan pendaftaran.html */
    :root {
      --hc-blue: #1a4787; --hc-toska: #0f8a94; --hc-bg: #e7e9ea;
      --hc-red: #d30e14; --card: #ffffff; --radius: 16px;
    }
    body { font-family: 'Poppins', sans-serif; background: var(--hc-bg); color: #2e2e2e; margin: 0; }
    .main-wrapper { padding: 40px 20px; min-height: 100vh; display: flex; align-items: flex-start; justify-content: center; }
    .container { max-width: 600px; width: 100%; }
    .card { background: var(--card); border-radius: var(--radius); box-shadow: 0 8px 30px rgba(26, 71, 135, 0.08); padding: 30px; border: 1px solid #cbd5e1; }
    
    .welcome-banner { background: linear-gradient(135deg, var(--hc-blue) 0%, var(--hc-toska) 100%); color: #fff; padding: 24px; border-radius: 12px; margin-bottom: 25px; text-align: center; }
    .welcome-banner h2 { margin: 0 0 6px; font-size: 22px; font-weight: 700; }
    .welcome-banner p { margin: 0; opacity: 0.9; font-size: 13px; }

    .instruction-box { background: #fff1f2; border-left: 4px solid var(--hc-red); padding: 15px; border-radius: 10px; margin-bottom: 25px; font-size: 13px; }
    
    .row { margin-bottom: 20px; }
    label { display: block; font-size: 13px; font-weight: 600; margin-bottom: 8px; color: #2e2e2e; }
    input, select, textarea { 
      width: 100%; padding: 12px 16px; border: 1px solid #cbd5e1; border-radius: 10px; 
      font-family: 'Poppins', sans-serif; font-size: 15px; outline: none; transition: 0.2s; background: #fff; box-sizing: border-box;
    }
    input:focus, textarea:focus { border-color: var(--hc-blue); box-shadow: 0 0 0 3px rgba(26, 71, 135, 0.15); }
    .input-error { border-color: var(--hc-red) !important; box-shadow: 0 0 0 3px rgba(211, 14, 20, 0.1) !important; }

    /* Photo Area & Camera UI */
    .photo-area { border: 2px dashed var(--hc-toska); border-radius: 16px; padding: 24px; text-align: center; background: #f0f9fa; position: relative; }
    #foto-preview-container { width: 150px; height: 150px; margin: 0 auto 16px; border-radius: 50%; overflow: hidden; border: 4px solid #fff; box-shadow: 0 4px 15px rgba(0,0,0,0.1); background: #e2e8f0; position: relative; }
    #foto-preview-img { width: 100%; height: 100%; object-fit: cover; }
    .btn-main-camera { display: inline-flex; align-items: center; justify-content: center; gap: 8px; background: white; border: 1px solid var(--hc-blue); color: var(--hc-blue); padding: 12px 24px; border-radius: 50px; font-weight: 600; font-size: 14px; cursor: pointer; transition: 0.2s; }
    .btn-main-camera:hover { background: var(--hc-blue); color: white; }
    .btn-delete-photo { background: #fee2e2; color: #ef4444; border: none; margin-top: 10px; padding: 8px 16px; border-radius: 8px; font-size: 12px; font-weight: 600; cursor: pointer; display: none; }

    /* Signature Styling */
    .sig-wrapper { height: 180px; border: 1px solid #cbd5e1; border-radius: 10px; position: relative; background: #fff; overflow: hidden; }
    canvas#sig-canvas { width: 100%; height: 100%; display: block; touch-action: none; }
    .sig-tools { position: absolute; top: 10px; right: 10px; z-index: 10; display: flex; gap: 8px; }
    .sig-btn { padding: 8px 16px; font-size: 12px; border: none; border-radius: 50px; cursor: pointer; display: flex; align-items: center; gap: 6px; font-weight: 600; font-family: 'Poppins', sans-serif; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    .sig-btn-undo { background: #e0f2fe; color: #0284c7; border: 1px solid #bae6fd; }
    .sig-btn-clear { background: #fee2e2; color: #ef4444; border: 1px solid #fecaca; }

    .btn-submit { 
      width: 100%; padding: 16px; background: linear-gradient(135deg, var(--hc-blue), var(--hc-toska)); 
      color: #fff; border: none; border-radius: 12px; font-weight: 700; font-size: 16px; cursor: pointer; margin-top: 20px; box-shadow: 0 4px 15px rgba(15, 138, 148, 0.3);
    }
    .btn-submit:disabled { opacity: 0.6; cursor: not-allowed; }

    /* Modal Styling */
    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 2500; display: none; align-items: center; justify-content: center; }
    .cam-box-modern { width: 100%; max-width: 500px; height: 100%; max-height: 100vh; background: #000; display: flex; flex-direction: column; position: relative; }
    #cam-video { width: 100%; height: 100%; object-fit: cover; }
    .cam-controls { height: 140px; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: space-between; padding: 0 40px; position: absolute; bottom: 0; left: 0; right: 0; border-top-left-radius: 20px; border-top-right-radius: 20px; backdrop-filter: blur(10px); }
    .btn-shutter-cam { width: 70px; height: 70px; border-radius: 50%; background: white; border: 4px solid rgba(255,255,255,0.3); cursor: pointer; }
    
    #crop-modal .modal-box { background: #1e293b; color: white; width: 90%; max-width: 400px; border-radius: 16px; padding: 20px; }
    .crop-actions { display: flex; gap: 10px; margin-top: 20px; }
    .btn-modal { flex: 1; padding: 12px; border-radius: 8px; border: none; cursor: pointer; font-weight: 600; }
    .btn-modal.cancel { background: var(--hc-red); color: white; } 
    .btn-modal.confirm { background: var(--hc-toska); color: white; }

    /* Header Back Button replacement */
    .btn-back-header { background: none; border: none; color: var(--hc-blue); font-size: 24px; cursor: pointer; display: flex; align-items: center; }
  </style>
</head>
<body>

  <div class="main-wrapper">
    <div class="container">
      <div class="card">
        <div class="welcome-banner">
          <h2>Perbaikan Data</h2>
          <p id="txt-code">Memuat data permintaan...</p>
        </div>

        <div id="instruction" class="instruction-box" style="display:none;">
          <strong>Alasan Penolakan:</strong><br>
          <span id="txt-reason">...</span>
        </div>

        <form id="form-perbaikan" style="display:none;">
          <div id="dynamic-fields"></div>
          
          <div class="row">
            <label>Pesan Tambahan untuk Pengurus (Opsional)</label>
            <textarea id="user-note" rows="3" placeholder="Jelaskan perbaikan yang Anda lakukan..."></textarea>
          </div>

          <button type="submit" class="btn-submit" id="btn-send">
            <i class="ri-send-plane-fill"></i> Kirim Perbaikan Data
          </button>
        </form>

        <div id="loading-init" style="text-align:center; padding: 40px;">
            <i class="ri-loader-4-line ri-spin" style="font-size: 40px; color: var(--hc-blue);"></i>
            <p style="font-size: 13px; color: #64748b; margin-top: 10px;">Mengambil rincian data...</p>
        </div>
      </div>
    </div>
  </div>

  <div id="cam-popup" class="modal-overlay">
      <div class="cam-box-modern">
          <div style="position:absolute; top:20px; right:20px; z-index:30;">
              <button onclick="stopCam()" style="background:var(--hc-red); color:white; border:none; width:40px; height:40px; border-radius:50%; font-size:20px; cursor:pointer;"><i class="ri-close-line"></i></button>
          </div>
          <video id="cam-video" autoplay playsinline muted></video>
          <div class="cam-controls">
              <button onclick="document.getElementById('inp-file-foto').click()" style="background:#ecec17; border:none; width:50px; height:50px; border-radius:50%; font-size:22px; cursor:pointer;"><i class="ri-image-add-line"></i></button>
              <input type="file" id="inp-file-foto" accept="image/*" hidden>
              <button class="btn-shutter-cam" id="btn-cam-capture"></button>
              <button id="btn-cam-switch" style="background:var(--hc-blue); color:white; border:none; width:50px; height:50px; border-radius:50%; font-size:22px; cursor:pointer;"><i class="ri-camera-switch-line"></i></button>
          </div>
      </div>
  </div>

  <div id="crop-modal" class="modal-overlay">
      <div class="modal-box">
          <h3 style="margin:0 0 15px; text-align:center; font-size:16px;">Sesuaikan Foto (1:1)</h3>
          <div style="height: 300px; width: 100%; background:#000; border-radius:8px; overflow:hidden;">
              <img id="cropper-img" src="" style="max-width: 100%;">
          </div>
          <div class="crop-actions">
              <button class="btn-modal cancel" id="btn-crop-cancel">Batal</button>
              <button class="btn-modal confirm" id="btn-crop-save">Simpan</button>
          </div>
      </div>
  </div>

  <script>
    let TRACKING_CODE = "";
    let DETAILED_DATA = null;
    let sigPad = null;
    let currentFacingMode = 'user';
    let stream = null;
    let cropper = null;

    document.addEventListener('DOMContentLoaded', function() {
      // Inisialisasi Header & Footer dari component.js
      initHC32Navigation('track'); 
      
      // Ganti Tombol Menu dengan Tombol Back
      const btnMenu = document.getElementById('hc32-btn-menu');
      if(btnMenu) {
        btnMenu.outerHTML = `<button class="btn-back-header" onclick="window.location.href='../../../bantuan/track/'"><i class="ri-arrow-left-line"></i></button>`;
      }

      const params = new URLSearchParams(location.search);
      TRACKING_CODE = params.get('code');
      if (!TRACKING_CODE) {
          alert("Kode tracking tidak ditemukan!");
          window.location.href = "../../../bantuan/track/";
          return;
      }
      document.getElementById('txt-code').innerText = "Kode: " + TRACKING_CODE;
      loadDataRequest();
    });

    async function loadDataRequest() {
      try {
        const res = await hc32_post('trackRequest', { 
            trackingCode: TRACKING_CODE, 
            secret: "ADMIN_BYPASS", 
            verifier: "ADMIN_BYPASS" 
        });
        
        if (res.status === 'ok') {
          DETAILED_DATA = res.request.detailedData;
          document.getElementById('txt-reason').innerText = res.request.publicNote;
          document.getElementById('instruction').style.display = 'block';
          generateFields(res.request.publicNote);
          document.getElementById('loading-init').style.display = 'none';
          document.getElementById('form-perbaikan').style.display = 'block';
        } else {
          throw new Error(res.message);
        }
      } catch (e) {
          document.getElementById('loading-init').innerHTML = `<p style='color:red'>Gagal memuat: ${e.message}</p>`;
      }
    }

    function generateFields(note) {
      const container = document.getElementById('dynamic-fields');
      const fieldsMap = [
        { key: "nama", label: "Nama Lengkap", type: "text" },
        { key: "email", label: "Alamat Email", type: "email" },
        { key: "nohp", label: "Nomor WhatsApp", type: "tel" },
        { key: "tanggalLahir", label: "Tanggal Lahir", type: "date" },
        { key: "foto", label: "Foto Profil", type: "file" },
        { key: "tandaTanganURL", label: "Tanda Tangan", type: "signature" }
      ];

      fieldsMap.forEach(field => {
        if (note.includes(field.label)) {
          const div = document.createElement('div');
          div.className = 'row';
          
          if (field.type === 'file') {
            div.innerHTML = `
              <label>${field.label} <span style="color:red">*</span></label>
              <div class="photo-area">
                <div id="foto-preview-container"><img id="foto-preview-img" src=""></div>
                <button type="button" class="btn-main-camera" id="btn-open-cam"><i class="ri-camera-fill"></i> Aktifkan Kamera</button>
                <div style="display:flex; justify-content:center;">
                   <button type="button" class="btn-delete-photo" id="btn-del-photo"><i class="ri-delete-bin-line"></i> Hapus Foto</button>
                </div>
                <input type="hidden" id="fd-foto-base64">
              </div>`;
          } else if (field.type === 'signature') {
            div.innerHTML = `
              <label>${field.label} <span style="color:red">*</span></label>
              <div class="sig-wrapper">
                <canvas id="sig-canvas"></canvas>
                <div class="sig-tools">
                  <button type="button" class="sig-btn sig-btn-undo" id="sig-undo"><i class="ri-arrow-go-back-line"></i> Undo</button>
                  <button type="button" class="sig-btn sig-btn-clear" id="sig-clear"><i class="ri-delete-bin-line"></i> Ulangi</button>
                </div>
              </div>`;
          } else {
            div.innerHTML = `<label>${field.label} <span style="color:red">*</span></label>
                             <input type="${field.type}" id="inp-${field.key}" value="${DETAILED_DATA ? (DETAILED_DATA[field.key] || '') : ''}" required>`;
          }
          container.appendChild(div);

          if (field.type === 'file') initPhotoLogic();
          if (field.type === 'signature') initSigLogic();
        }
      });
    }

    // --- PHOTO LOGIC ---
    function initPhotoLogic() {
      document.getElementById('btn-open-cam').onclick = startCam;
      document.getElementById('btn-cam-capture').onclick = capturePhoto;
      document.getElementById('btn-del-photo').onclick = () => {
        document.getElementById('fd-foto-base64').value = "";
        document.getElementById('foto-preview-img').src = "";
        document.getElementById('foto-preview-container').style.display = "none";
        document.getElementById('btn-del-photo').style.display = "none";
      };
      document.getElementById('inp-file-foto').onchange = (e) => {
        if(e.target.files[0]) {
           if(e.target.files[0].size > 1.1 * 1024 * 1024) { 
             window.showHC32Status('error', 'File Besar', 'Maksimal ukuran foto adalah 1 MB.'); 
             return; 
           }
           const r = new FileReader(); 
           r.onload = (evt) => { stopCam(); openCropper(evt.target.result); }; 
           r.readAsDataURL(e.target.files[0]);
        }
      };
    }

    async function startCam() {
      try {
        stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: currentFacingMode } });
        const video = document.getElementById('cam-video');
        video.srcObject = stream;
        video.style.transform = (currentFacingMode === 'user') ? 'none' : 'none'; // Jangan di mirror
        document.getElementById('cam-popup').style.display = 'flex';
      } catch(e) { window.showHC32Status('error', 'Kamera', 'Gagal mengakses kamera.'); }
    }

    function stopCam() {
      if(stream) stream.getTracks().forEach(t => t.stop());
      document.getElementById('cam-popup').style.display = 'none';
    }

    function capturePhoto() {
      const video = document.getElementById('cam-video');
      const canvas = document.createElement('canvas');
      canvas.width = video.videoWidth; canvas.height = video.videoHeight;
      canvas.getContext('2d').drawImage(video, 0, 0);
      stopCam();
      openCropper(canvas.toDataURL('image/jpeg'));
    }

    function openCropper(src) {
      const img = document.getElementById('cropper-img');
      img.src = src;
      document.getElementById('crop-modal').style.display = 'flex';
      if(cropper) cropper.destroy();
      cropper = new Cropper(img, { aspectRatio: 1, viewMode: 1 });
    }

    document.getElementById('btn-crop-cancel').onclick = () => {
      document.getElementById('crop-modal').style.display = 'none';
      cropper.destroy();
    };

    document.getElementById('btn-crop-save').onclick = () => {
      const cvs = cropper.getCroppedCanvas({ width: 600, height: 600 });
      const base64 = cvs.toDataURL('image/jpeg', 0.8);
      document.getElementById('fd-foto-base64').value = base64;
      const preview = document.getElementById('foto-preview-img');
      preview.src = base64;
      document.getElementById('foto-preview-container').style.display = 'block';
      document.getElementById('btn-del-photo').style.display = 'block';
      document.getElementById('crop-modal').style.display = 'none';
      cropper.destroy();
    };

    // --- SIGNATURE LOGIC ---
    function initSigLogic() {
      const canvas = document.getElementById('sig-canvas');
      sigPad = new SignaturePad(canvas);
      window.addEventListener('resize', () => {
        const ratio = Math.max(window.devicePixelRatio || 1, 1);
        canvas.width = canvas.offsetWidth * ratio; canvas.height = canvas.offsetHeight * ratio;
        canvas.getContext("2d").scale(ratio, ratio);
        sigPad.clear();
      });
      window.dispatchEvent(new Event('resize'));
      document.getElementById('sig-clear').onclick = () => sigPad.clear();
      document.getElementById('sig-undo').onclick = () => {
        const data = sigPad.toData();
        if (data) { data.pop(); sigPad.fromData(data); }
      };
    }

    // --- SUBMIT ---
    document.getElementById('form-perbaikan').onsubmit = async function(e) {
      e.preventDefault();
      
      // Validasi sederhana
      const email = document.getElementById('inp-email');
      if(email && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email.value)) {
        window.showHC32Status('error', 'Email', 'Format email tidak valid.');
        return;
      }

      window.showHC32Status('loading', 'Mengirim Data', 'Mohon tunggu sebentar...');
      const btnSend = document.getElementById('btn-send');
      btnSend.disabled = true;

      const updatedData = {};
      const inputs = document.querySelectorAll('#dynamic-fields input:not([type="hidden"])');
      inputs.forEach(inp => { updatedData[inp.id.replace('inp-', '')] = inp.value; });

      const foto = document.getElementById('fd-foto-base64');
      if(foto && foto.value) updatedData['fotoBase64'] = foto.value;

      if(sigPad && !sigPad.isEmpty()) updatedData['ttdBase64'] = sigPad.toDataURL();

      try {
        const res = await hc32_post('submitPerbaikanMandiri', {
            trackingCode: TRACKING_CODE,
            updatedData: updatedData,
            note: document.getElementById('user-note').value
        });

        if (res.status === 'ok') {
          window.showHC32Status('success', 'Berhasil', 'Data perbaikan telah dikirim ke pengurus.');
          setTimeout(() => {
              window.location.href = "../../../bantuan/track/?code=" + encodeURIComponent(TRACKING_CODE);
          }, 2500);
        } else {
          throw new Error(res.message);
        }
      } catch (err) {
        window.showHC32Status('error', 'Gagal', err.message);
        btnSend.disabled = false;
      }
    };
  </script>
</body>
</html>
