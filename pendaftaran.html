<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Pendaftaran Anggota HC 32</title>
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" rel="stylesheet">
  
  <script src="config.js"></script>
  <script src="components.js"></script>
  
  <style>
    /* ... CSS Dasar (Sama seperti sebelumnya) ... */
    body { font-family: 'Poppins', sans-serif; background-color: #f8fafc; color: #2e2e2e; margin: 0; padding: 0; display: flex; flex-direction: column; min-height: 100vh; }
    .main-wrapper { flex: 1; padding: 40px 20px; }
    .container { max-width: 600px; margin: 0 auto; }
    .card { background: #ffffff; border-radius: 16px; box-shadow: 0 8px 30px rgba(26, 71, 135, 0.08); padding: 30px; border: 1px solid #cbd5e1; }
    .welcome-banner { background: linear-gradient(135deg, var(--hc-blue) 0%, var(--hc-toska) 100%); color: #fff; padding: 24px; border-radius: 12px; margin-bottom: 28px; text-align: center; }
    .welcome-banner h2 { margin: 0 0 6px; font-size: 24px; font-weight: 700; }
    .welcome-banner p { margin: 0; opacity: 0.9; font-size: 14px; font-weight: 300; }
    
    /* Form Elements */
    .row { margin-bottom: 20px; }
    label { display: block; font-size: 13px; font-weight: 600; margin-bottom: 8px; color: var(--hc-dark); }
    input, select { width: 100%; padding: 12px 16px; border: 1px solid #cbd5e1; border-radius: 10px; font-size: 15px; outline: none; background: #fff; box-sizing: border-box; transition: 0.2s; font-family: 'Poppins', sans-serif; }
    input:focus, select:focus { border-color: var(--hc-blue); box-shadow: 0 0 0 3px rgba(26, 71, 135, 0.15); }
    .two-col { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    .hidden { display: none !important; }
    
    button[type="submit"] { width: 100%; background: linear-gradient(135deg, var(--hc-blue), var(--hc-toska)); color: #fff; border: none; padding: 16px; border-radius: 10px; font-weight: 600; font-size: 16px; cursor: pointer; margin-top: 10px; box-shadow: 0 4px 15px rgba(15, 138, 148, 0.3); transition: 0.2s; }
    button[type="submit"]:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(15, 138, 148, 0.4); }
    button[type="submit"]:disabled { background: #cbd5e1; cursor: not-allowed; transform: none; box-shadow: none; }

    /* === UI KAMERA BARU === */
    .photo-section { text-align: center; margin-bottom: 30px; }
    
    /* Tombol Utama di Form */
    .btn-main-camera {
        display: inline-flex; align-items: center; justify-content: center; gap: 8px;
        background: #fff; border: 2px dashed var(--hc-blue); color: var(--hc-blue);
        padding: 12px 24px; border-radius: 12px; font-weight: 600; cursor: pointer;
        width: 100%; transition: all 0.2s;
    }
    .btn-main-camera:hover { background: #f0f9fa; border-color: var(--hc-toska); color: var(--hc-toska); }

    /* Preview Hasil Foto */
    .photo-result-wrapper {
        position: relative; width: 150px; height: 150px; margin: 0 auto;
        border-radius: 50%; overflow: hidden; border: 4px solid var(--hc-blue);
        box-shadow: 0 4px 15px rgba(0,0,0,0.1); display: none; /* Hidden by default */
    }
    .photo-result-img { width: 100%; height: 100%; object-fit: cover; }
    .btn-remove-photo {
        margin-top: 10px; font-size: 13px; color: var(--hc-red); 
        background: none; border: none; cursor: pointer; text-decoration: underline;
    }

    /* === POPUP KAMERA FULLSCREEN === */
    .cam-modal {
        position: fixed; inset: 0; background: #000; z-index: 9999;
        display: none; flex-direction: column;
    }
    .cam-header {
        padding: 20px; display: flex; justify-content: flex-end;
        position: absolute; top: 0; left: 0; right: 0; z-index: 10;
    }
    .btn-close-cam {
        color: #fff; background: rgba(0,0,0,0.3); border: none; 
        font-size: 24px; width: 40px; height: 40px; border-radius: 50%; cursor: pointer;
    }

    /* Video Area */
    .cam-video-container {
        flex: 1; display: flex; align-items: center; justify-content: center;
        background: #000; overflow: hidden; position: relative;
    }
    video#cam-feed {
        width: 100%; height: 100%; object-fit: cover;
        /* Mirror effect for front camera */
        transform: scaleX(-1); 
    }
    
    /* Camera Controls (Bottom) */
    .cam-controls {
        height: 120px; background: rgba(0,0,0,0.8);
        display: flex; align-items: center; justify-content: space-around;
        padding: 0 30px; position: relative;
    }

    /* Tombol Shutter (Tengah) */
    .btn-shutter {
        width: 70px; height: 70px; border-radius: 50%;
        background: #fff; border: 4px solid rgba(255,255,255,0.3);
        cursor: pointer; transition: 0.1s;
    }
    .btn-shutter:active { transform: scale(0.9); background: #ddd; }

    /* Tombol Samping (Upload & Switch) */
    .btn-cam-side {
        background: none; border: none; color: #fff; cursor: pointer;
        display: flex; flex-direction: column; align-items: center; gap: 4px;
        font-size: 12px; opacity: 0.8; width: 60px;
    }
    .btn-cam-side svg { width: 28px; height: 28px; fill: #fff; }
    .btn-cam-side:hover { opacity: 1; }

    /* File Input Hidden */
    #inp-file-hidden { display: none; }

    /* === CROPPER MODAL === */
    .crop-modal {
        position: fixed; inset: 0; background: #1a1a1a; z-index: 10000;
        display: none; flex-direction: column;
    }
    .crop-container { flex: 1; position: relative; background: #000; }
    .crop-image { display: block; max-width: 100%; }
    .crop-actions {
        padding: 20px; display: flex; justify-content: space-between; background: #1a1a1a;
    }
    .btn-crop {
        padding: 10px 24px; border-radius: 30px; border: none; font-weight: 600; cursor: pointer;
    }
    .btn-crop.cancel { background: #333; color: #fff; }
    .btn-crop.save { background: var(--hc-blue); color: #fff; }

    /* === SIGNATURE & OTHERS === */
    .sig-wrapper { height: 180px; border: 1px solid #cbd5e1; border-radius: 10px; position: relative; background: #fff; }
    canvas#sig-canvas { width: 100%; height: 100%; display: block; }
    .sig-clear-btn { 
        position: absolute; top: 10px; right: 10px; z-index: 10;
        padding: 4px 10px; background: #fff; border: 1px solid var(--hc-red); 
        color: var(--hc-red); border-radius: 6px; cursor: pointer; font-size: 12px;
    }

    /* === LOADER & STATUS (Copy dari sebelumnya) === */
    #hc32-loading-overlay { position: fixed; inset: 0; background: rgba(255,255,255,0.9); backdrop-filter: blur(4px); display: none; align-items: center; justify-content: center; z-index: 9999; flex-direction: column; }
    .hc-loader-spinner { width: 50px; height: 50px; border: 5px solid var(--hc-blue); border-top-color: var(--hc-toska); border-radius: 50%; animation: hcspin 1s linear infinite; }
    @keyframes hcspin { to { transform: rotate(360deg); } }
    .status-modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 11000; display: none; align-items: center; justify-content: center; }
    .status-modal-box { background: #fff; padding: 30px; border-radius: 16px; text-align: center; width: 85%; max-width: 320px; }
    .status-btn { width: 100%; padding: 12px; background: var(--hc-blue); color: #fff; border: none; border-radius: 8px; margin-top: 20px; cursor: pointer; }

    @media (min-width: 768px) {
        /* Di Desktop, batasi ukuran modal kamera agar tidak terlalu raksasa */
        .cam-modal { left: 50%; top: 50%; transform: translate(-50%, -50%); width: 400px; height: 700px; border-radius: 20px; overflow: hidden; box-shadow: 0 20px 50px rgba(0,0,0,0.5); }
        .crop-modal { left: 50%; top: 50%; transform: translate(-50%, -50%); width: 400px; height: 700px; border-radius: 20px; overflow: hidden; }
    }
  </style>
</head>
<body>

  <div id="hc32-loading-overlay"><div class="hc-loader-spinner"></div><p style="margin-top:10px;font-weight:600">Memproses...</p></div>
  <div id="status-modal" class="status-modal-overlay">
      <div class="status-modal-box">
          <h3 id="status-title" style="margin:0 0 10px;">Judul</h3>
          <p id="status-desc" style="margin:0; color:#666;">Pesan status.</p>
          <button id="status-btn" class="status-btn">Oke</button>
      </div>
  </div>

  <div id="cam-modal" class="cam-modal">
      <div class="cam-header">
          <button class="btn-close-cam" id="btn-close-cam">Ã—</button>
      </div>
      
      <div class="cam-video-container">
          <video id="cam-feed" autoplay playsinline muted></video>
      </div>

      <div class="cam-controls">
          <button class="btn-cam-side" id="btn-upload-trigger">
              <svg viewBox="0 0 24 24"><path d="M19 5v14H5V5h14m0-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-4.86 8.86l-3 3.87L9 13.14 6 17h12l-3.86-5.14z"/></svg>
              <span>Upload</span>
          </button>
          
          <button class="btn-shutter" id="btn-shutter"></button>
          
          <button class="btn-cam-side" id="btn-switch-cam">
              <svg viewBox="0 0 24 24"><path d="M20 4h-3.17L15 2H9L7.17 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm-5 11.5V13H9v2.5L5.5 12 9 8.5V11h6V8.5l3.5 3.5-3.5 3.5z"/></svg>
              <span>Putar</span>
          </button>
      </div>
      <input type="file" id="inp-file-hidden" accept="image/*">
  </div>

  <div id="crop-modal" class="crop-modal">
      <div class="crop-container">
          <img id="image-to-crop" src="" alt="Crop Preview">
      </div>
      <div class="crop-actions">
          <button class="btn-crop cancel" id="btn-cancel-crop">Batal</button>
          <button class="btn-crop save" id="btn-save-crop">Simpan Foto</button>
      </div>
  </div>

  <div class="main-wrapper">
      <div class="container">
          <div class="card">
              <div class="welcome-banner">
                  <h2>Formulir Pendaftaran</h2>
                  <p>Bergabunglah bersama kami di History Club SMAN 32.</p>
              </div>

              <form id="form-daftar" novalidate>
                  <div class="row">
                      <label for="fd-nis" id="label-id">NIS / Identitas *</label>
                      <input id="fd-nis" placeholder="Nomor Induk Siswa" required />
                  </div>
                  <div class="row">
                      <label for="fd-nama">Nama Lengkap *</label>
                      <input id="fd-nama" placeholder="Sesuai Absen" required />
                  </div>
                  <div class="row">
                      <label for="fd-tipe">Tipe Keanggotaan *</label>
                      <select id="fd-tipe">
                          <option value="siswa">Siswa Aktif</option>
                          <option value="guru">Guru/Tendik</option>
                          <option value="alumni">Alumni</option>
                      </select>
                  </div>

                  <div id="group-siswa" class="row">
                      <div class="two-col">
                          <div><label>Kelas</label><select id="fd-kelas"></select></div>
                          <div><label>Angkatan</label><select id="fd-angkatan"></select></div>
                      </div>
                  </div>

                  <div class="row"><label>No HP (WA) *</label><input id="fd-nohp" type="tel" required /></div>

                  <div class="row photo-section">
                      <label>Foto Profil (Wajib)</label>
                      
                      <button type="button" class="btn-main-camera" id="btn-open-modal">
                          <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
                          Ambil / Upload Foto
                      </button>

                      <div id="result-container" style="display:none; margin-top:15px;">
                          <div class="photo-result-wrapper">
                              <img id="final-photo" class="photo-result-img" src="">
                          </div>
                          <button type="button" class="btn-remove-photo" id="btn-hapus-foto">Hapus Foto</button>
                      </div>
                      <input type="hidden" id="fd-foto-base64">
                  </div>

                  <div class="row">
                      <label>Tanda Tangan Digital *</label>
                      <div class="sig-wrapper">
                          <canvas id="sig-canvas"></canvas>
                          <button type="button" class="sig-clear-btn" id="sig-clear">Ulangi</button>
                      </div>
                  </div>

                  <button type="submit" id="btn-submit">Kirim Pendaftaran</button>
              </form>
          </div>
      </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.1.7/dist/signature_pad.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>

  <script>
    // == INIT SHARED UI ==
    document.addEventListener('DOMContentLoaded', () => {
        initHC32Navigation('pendaftaran');
        populateDropdowns();
        initSig();
    });

    // == VARIABLES ==
    let stream = null;
    let cropper = null;
    let currentFacingMode = 'user'; // 'user' = depan, 'environment' = belakang

    const els = {
        btnOpen: document.getElementById('btn-open-modal'),
        camModal: document.getElementById('cam-modal'),
        btnCloseCam: document.getElementById('btn-close-cam'),
        video: document.getElementById('cam-feed'),
        btnShutter: document.getElementById('btn-shutter'),
        btnSwitch: document.getElementById('btn-switch-cam'),
        btnUpload: document.getElementById('btn-upload-trigger'),
        inpFile: document.getElementById('inp-file-hidden'),
        
        cropModal: document.getElementById('crop-modal'),
        imgCrop: document.getElementById('image-to-crop'),
        btnCancelCrop: document.getElementById('btn-cancel-crop'),
        btnSaveCrop: document.getElementById('btn-save-crop'),
        
        resultContainer: document.getElementById('result-container'),
        finalImg: document.getElementById('final-photo'),
        btnHapus: document.getElementById('btn-hapus-foto'),
        hiddenInput: document.getElementById('fd-foto-base64')
    };

    // == CAMERA FUNCTIONS ==
    
    // 1. Buka Modal Kamera
    els.btnOpen.addEventListener('click', async () => {
        els.camModal.style.display = 'flex';
        await startCamera();
    });

    // 2. Start Camera Stream
    async function startCamera() {
        if(stream) stopCamera(); // Stop dulu kalo ada sisa
        try {
            const constraints = {
                video: { facingMode: currentFacingMode, width: { ideal: 1280 }, height: { ideal: 1280 } },
                audio: false
            };
            stream = await navigator.mediaDevices.getUserMedia(constraints);
            els.video.srcObject = stream;
            
            // Mirror efek cuma buat kamera depan
            els.video.style.transform = (currentFacingMode === 'user') ? 'scaleX(-1)' : 'none';
        } catch (err) {
            alert("Gagal mengakses kamera. Pastikan izin diberikan.");
            els.camModal.style.display = 'none';
        }
    }

    // 3. Stop Camera
    function stopCamera() {
        if (stream) {
            stream.getTracks().forEach(track => track.stop());
            stream = null;
        }
    }

    // 4. Tutup Modal Kamera
    els.btnCloseCam.addEventListener('click', () => {
        stopCamera();
        els.camModal.style.display = 'none';
    });

    // 5. Switch Camera (Depan/Belakang)
    els.btnSwitch.addEventListener('click', async () => {
        currentFacingMode = (currentFacingMode === 'user') ? 'environment' : 'user';
        await startCamera();
    });

    // 6. Upload File Trigger
    els.btnUpload.addEventListener('click', () => els.inpFile.click());
    
    els.inpFile.addEventListener('change', (e) => {
        if(e.target.files && e.target.files[0]) {
            processFileForCrop(e.target.files[0]);
        }
    });

    // 7. JEPRET FOTO
    els.btnShutter.addEventListener('click', () => {
        const canvas = document.createElement('canvas');
        canvas.width = els.video.videoWidth;
        canvas.height = els.video.videoHeight;
        const ctx = canvas.getContext('2d');
        
        // Handle Mirroring kalau kamera depan
        if (currentFacingMode === 'user') {
            ctx.translate(canvas.width, 0);
            ctx.scale(-1, 1);
        }
        ctx.drawImage(els.video, 0, 0);
        
        canvas.toBlob((blob) => {
            processFileForCrop(blob);
        }, 'image/jpeg');
    });

    // == CROPPER FUNCTIONS ==

    function processFileForCrop(fileBlob) {
        // Stop kamera dulu biar hemat baterai/ram
        stopCamera();
        els.camModal.style.display = 'none'; // Tutup modal kamera
        
        // Tampilkan modal crop
        els.cropModal.style.display = 'flex';
        els.imgCrop.src = URL.createObjectURL(fileBlob);
        
        // Init CropperJS
        if (cropper) cropper.destroy();
        cropper = new Cropper(els.imgCrop, {
            aspectRatio: 1, // Wajib 1:1
            viewMode: 1,
            dragMode: 'move',
            autoCropArea: 1,
        });
    }

    els.btnCancelCrop.addEventListener('click', () => {
        els.cropModal.style.display = 'none';
        if (cropper) cropper.destroy();
        // Buka lagi kamera kalau batal crop
        els.camModal.style.display = 'flex';
        startCamera();
    });

    els.btnSaveCrop.addEventListener('click', () => {
        if (!cropper) return;
        
        // Ambil hasil crop, resize max 600px biar ringan
        const canvas = cropper.getCroppedCanvas({ width: 600, height: 600, fillColor: '#fff' });
        
        // Convert ke Base64 (JPG kualitas 85%)
        const base64 = canvas.toDataURL('image/jpeg', 0.85);
        
        // Tampilkan di Form
        els.finalImg.src = base64;
        els.hiddenInput.value = base64;
        
        els.resultContainer.style.display = 'block'; // Munculkan preview
        els.btnOpen.style.display = 'none'; // Sembunyikan tombol ambil foto
        
        // Bersihkan
        els.cropModal.style.display = 'none';
        if(cropper) cropper.destroy();
    });

    // Hapus Foto (Reset ke awal)
    els.btnHapus.addEventListener('click', () => {
        els.hiddenInput.value = '';
        els.finalImg.src = '';
        els.resultContainer.style.display = 'none';
        els.btnOpen.style.display = 'inline-flex';
    });


    // == FORM HELPERS (Sama seperti sebelumnya) ==
    function populateDropdowns() {
        const sel = document.getElementById('fd-kelas');
        ['X', 'XI', 'XII'].forEach(t => { for(let i=1; i<=8; i++) sel.add(new Option(`${t}-${i}`, `${t}-${i}`)); });
        const ang = document.getElementById('fd-angkatan');
        [2026, 2027, 2028].forEach(y => ang.add(new Option(y, y)));
    }

    // == SIGNATURE ==
    let signaturePad = null;
    const sigCanvas = document.getElementById('sig-canvas');
    function initSig() {
        const ratio = Math.max(window.devicePixelRatio || 1, 1);
        sigCanvas.width = sigCanvas.offsetWidth * ratio;
        sigCanvas.height = sigCanvas.offsetHeight * ratio;
        sigCanvas.getContext("2d").scale(ratio, ratio);
        signaturePad = new SignaturePad(sigCanvas);
    }
    document.getElementById('sig-clear').addEventListener('click', () => signaturePad.clear());
    window.addEventListener('resize', initSig);

    // == SUBMIT ==
    const statusModal = document.getElementById('status-modal');
    const statusTitle = document.getElementById('status-title');
    const statusDesc = document.getElementById('status-desc');
    const statusIconContainer = document.getElementById('status-icon-container');
    const statusBtn = document.getElementById('status-btn');
    const loader = document.getElementById('hc32-loading-overlay');

    function showStatus(type, title, msg) {
        statusModal.style.display = 'flex';
        statusTitle.textContent = title;
        statusDesc.textContent = msg;
        statusIconContainer.className = 'status-icon-circle ' + type;
        statusIconContainer.innerHTML = type==='success' ? 
            '<svg class="status-icon-svg" viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"></polyline></svg>' : 
            '<svg class="status-icon-svg" viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>';
    }
    statusBtn.onclick = () => statusModal.style.display = 'none';

    document.getElementById('form-daftar').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        if(signaturePad.isEmpty()) { showStatus('error', 'Gagal', 'Tanda tangan wajib diisi.'); return; }
        if(!els.hiddenInput.value) { showStatus('error', 'Gagal', 'Foto profil wajib diisi.'); return; }

        loader.style.display = 'flex';
        
        const data = {
            nis: document.getElementById('fd-nis').value,
            nama: document.getElementById('fd-nama').value,
            tipe: document.getElementById('fd-tipe').value,
            kelas: document.getElementById('fd-kelas').value,
            angkatan: document.getElementById('fd-angkatan').value,
            nohp: document.getElementById('fd-nohp').value,
            email: document.getElementById('fd-email').value,
            fotoBase64: els.hiddenInput.value,
            tandaTangan: signaturePad.toDataURL(),
            action: 'pendaftaran'
        };

        try {
            // Gunakan hc32_post dari config.js
            const res = await hc32_post('pendaftaran', data);
            loader.style.display = 'none';
            
            if(res.status === 'ok') {
                showStatus('success', 'Berhasil!', 'Data Anda telah tersimpan.');
                e.target.reset();
                signaturePad.clear();
                els.btnHapus.click(); // Reset foto UI
            } else {
                showStatus('error', 'Gagal', res.message || 'Terjadi kesalahan.');
            }
        } catch(err) {
            loader.style.display = 'none';
            showStatus('error', 'Error Jaringan', err.message);
        }
    });
  </script>
</body>
</html>
